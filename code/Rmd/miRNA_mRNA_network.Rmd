---
title: "miRNA-mRNA network analysis with mixed effect modilng"
author: "Lorena Pantano"
date: "`r date()`"
output: html_document
---

```{r knitr,eval=F,echo=F}
library(rmarkdown)
library(knitrBootstrap)
#render("~/repos/pcbc_c4_analysis/code/Rmd/miRNA_mRNA_network.Rmd", output_dir = "~/Dropbox/Public/hsph/pcbc")
```


Find miRNA-mRNA networks using limma:voom to detect DE features and miRBD v5 for miRNA-mRNA pairs.


```{r load}

library(tidyr)
library(dplyr)
library(knitr)
library(synapseClient)
library(limma)
library(reshape2)
library(gplots)
library(ggplot2)
library(RColorBrewer)
library(pheatmap)

options(bitmapType = 'cairo')

synapseLogin()

knitr::opts_chunk$set(tidy=TRUE, highlight=TRUE, dev="png", fig.width=9,fig.heigh=9,
               cache=FALSE, highlight=TRUE, autodep=TRUE, warning=FALSE, error=FALSE,
               message=FALSE, prompt=TRUE, comment='', fig.cap='', bootstrap.show.code=FALSE, echo=FALSE)

mirna_pval_obj =  synGet(id="syn4596141")
mirna_pval = read.table(mirna_pval_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")
mirna_logfc_obj =  synGet(id="syn4595547")
mirna_logfc = read.table(mirna_logfc_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")

mrna_logfc_obj =  synGet(id="syn4484226")
mrna_logfc = read.table(mrna_logfc_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")
mrna_pval_obj =  synGet(id="syn4484228")
mrna_pval = read.table(mrna_pval_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")


metadata_id = "syn3219876"
metadata_obj = synTableQuery(paste('SELECT * FROM',metadata_id,sep=' '))
metadata = metadata_obj@values %>% distinct(UID)
row.names(metadata) = metadata$UID
stages =  gsub("-5","5",gsub("-30","LATE",gsub("-15","LATE",metadata$Diffname_short)))
metadata$Diffname_short = as.character(stages)

mirna_rlog_obj =  synGet(id="syn4595556")
rlog_Mat = read.table(mirna_rlog_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")

meth_mirna_map_id = "syn4895962"
meth_mirna_map_obj = synGet(meth_mirna_map_id)
meth_mirna_map = read.table(meth_mirna_map_obj@filePath, header=F, sep="\t")
# meth_mirna_map = read.table("../../data/hm450_gene_annotations_mapped_mirna_tss.tsv", header=F, sep="\t")
names(meth_mirna_map) = c("meth", "mirna")

meth_pval_id = "syn4596513"
meth_pval_obj = synGet(meth_pval_id)
meth_pval = read.table(meth_pval_obj@filePath, header=TRUE, sep ="\t", row.names = 1)
#names(meth_pval) = gsub("vs", "_vs", names(meth_pval))

meth_fc_id = "syn4596511"
meth_fc_obj = synGet(meth_fc_id)
meth_fc = read.table(meth_fc_obj@filePath, header=TRUE, sep ="\t", row.names = 1)

.grep <- function(df, comp){
  idx = rowSums( sapply(paste0('_',comp,'_'), function(x)grepl(x, names(df))) ) > 0
  df[,idx]
}

.convert_to_ensembl <- function(m){
  require(biomaRt)
  ensembl = useMart('ensembl', dataset = "hsapiens_gene_ensembl")
  df = getBM(attributes=c("ensembl_gene_id", "external_gene_name"), filters="external_gene_name", values=as.character(rownames(m)), mart=ensembl)
  df = df %>% filter(ensembl_gene_id != "")
  new_m = m[as.character(df$external_gene_name),]
  row.names(new_m) = as.character(df$ensembl_gene_id)
  return(new_m)
}


format_table = function(m_logfc, m_pval, FC=2, PVAL=0.01, map=FALSE){
    if (map){
      m_logfc = .convert_to_ensembl(m_logfc)
      m_pval = .convert_to_ensembl(m_pval)
    }
    m_logfc = .grep(m_logfc, comp)
    m_pval = .grep(m_pval, comp)
    
    m_sig = lapply(names(m_pval), function(x){
      
      sig = m_pval[,x] < PVAL & abs(m_logfc[,x]) > FC
      sig[is.na(sig)] = FALSE
      if (sum(sig)>0){
        dt = data.frame(fc=m_logfc[sig, x],gene=rownames(m_logfc)[sig])
      
        dt$cont = x
        return(dt)
      }
    })
    do.call(rbind, m_sig)
}


comp = c("DE", "SC", "MESO5", "ECTO", "EB")

mirna_tab = format_table(mirna_logfc, mirna_pval, FC=1)
meth_tab = format_table(meth_fc, meth_pval, FC=0.2, PVAL=0.05)
mrna_tab = format_table(mrna_logfc, mrna_pval, FC=1, map=TRUE)

target_obj = synGet(id="syn3461627")
target = read.table(target_obj@filePath, check.names = F, header=F, sep="\t")
names(target) = c("mirna","gene")
```

# Detect networks

For mRNA and miRNA using adjusted pval < 0.01 and abs(logFC) > 1 and for methylation, abs(logFC) > 0.2 and FDR < 0.05 to get more interactions.

```{r create-network}
network_list = list()
for (contrast in intersect(unique(mrna_tab$cont), unique(mirna_tab$cont)) ){
    genes_de = mrna_tab %>% filter(cont == contrast )
    mirna_de = mirna_tab %>% filter(cont == contrast)
    target_de = target %>% filter(gene %in% genes_de$gene & mirna %in% mirna_de$gene)
    idx_mirna = match(mirna_de$gene, target_de$mirna)
    idx_mrna = match(genes_de$gene, target_de$gene)
    target_de[idx_mirna[!is.na(idx_mirna)],"mirna_fc"] = mirna_de$fc[!is.na(idx_mirna)]
    target_de[idx_mrna[!is.na(idx_mrna)],"mrna_fc"] = genes_de$fc[!is.na(idx_mrna)]
    network = target_de %>% filter(!is.na(mirna_fc) & !is.na(mrna_fc) & mirna_fc * mrna_fc < 0)
    if (dim(network)[1]>0){
      network_list[[contrast]] = network %>% mutate(contrast = contrast)
    }
}

network_meth_list = list()
for (contrast in intersect(unique(meth_tab$cont), unique(mirna_tab$cont)) ){
    genes_de = meth_tab %>% filter(cont == contrast )
    mirna_de = mirna_tab %>% filter(cont == contrast)
    target_de = meth_mirna_map %>% filter(meth %in% genes_de$gene & mirna %in% mirna_de$gene)
    idx_mirna = match(mirna_de$gene, target_de$mirna)
    idx_mrna = match(genes_de$gene, target_de$meth)
    target_de[idx_mirna[!is.na(idx_mirna)],"mirna_fc"] = mirna_de$fc[!is.na(idx_mirna)]
    target_de[idx_mrna[!is.na(idx_mrna)],"meth_fc"] = genes_de$fc[!is.na(idx_mrna)]
    network = target_de %>% filter(!is.na(mirna_fc) & !is.na(meth_fc) & mirna_fc * meth_fc < 0)
    if (dim(network)[1]>0){
      network_meth_list[[contrast]] = network %>% mutate(contrast = contrast)
    }
}

```

## Numbers of interaction in all comparisons

For mRNA-miRNA

```{r summary, results='asis'}
kable(as.data.frame(sapply(network_list, nrow)))
```

For methylation-miRNA

```{r summary-meth, results='asis'}
kable(as.data.frame(sapply(network_meth_list, nrow)))
```

## Common interactions for mRNA-miRNA

```{r summary-unique, results='asis'}
dd = do.call(rbind, network_list)
dd$id = paste0(dd$mirna,"->",dd$gene)
dd_times = dd %>% group_by(id) %>% dplyr::summarise(times = n()) %>% dplyr::arrange(desc(times))
dd_complete = merge(dd, dd_times, by="id") %>% dplyr::arrange(desc(times))

kable(head(merge(dd, dd_times, by="id") %>% filter(times>1) %>% dplyr::arrange(desc(times))))

```

## methylation - miRNA - mRNA interaction

Only 2 interactions affecting methylation-miRNA-mRNA in the same comparison.

```{r c3-network}
meth_mirna_res = do.call(rbind,network_meth_list) %>% mutate(id=paste0(mirna, contrast))
mrna_mirna_res = do.call(rbind,network_list) %>% mutate(id=paste0(mirna, contrast))

c3_res = merge(mrna_mirna_res, meth_mirna_res, by ='id')

kable(c3_res)

```


```{r pheatmap, eval=FALSE, echo=FALSE}
tt = apply(dd_complete, 1, function(x){
  comp = unlist(strsplit(x[6],split = "_"))
  #g1 = c(x[1], x[5], comp[3])
  #g2 = c(x[1], -1 * as.numeric(x[5]), comp[5])
  return(  data.frame(pair=c(x[1], x[1]), fc=c(x[5], -1 * as.numeric(x[5])), comp=c(comp[3], comp[5])  ))
})

tt = do.call(rbind,tt)

tt$fc = as.numeric(as.character(tt$fc))

tt_m = reshape(as.data.frame(tt), direction = 'wide', idvar='pair', timevar = "comp")
tt_m[is.na(tt_m)] = 0
pheatmap(tt_m, show_rownames = FALSE)
```


```{r network-gene-mirna-meso-early, fig.width=11, fig.height=11, eval=FALSE, echo=FALSE}
dd_reduce = merge(dd, dd_times, by="id")  %>% filter(grepl("MESO5", contrast) & !grepl("MESO15", contrast)) %>% dplyr::arrange(desc(times)) %>% mutate(contrast=gsub("MESO30", "", contrast))
con = rbind( data.frame(start=dd_reduce$mirna, end=dd_reduce$gene),
             data.frame(start=dd_reduce$contrast, end=dd_reduce$mirna ))
con = con %>% distinct()
suppressMessages(library(igraph))
gr<-graph.data.frame(con, directed = F)
V(gr)$color<-"white"
V(gr)$color[grep("hsa-",V(gr)$name)]<-"orange"
V(gr)$color[grep("ENSG",V(gr)$name)]<-"black"
V(gr)$name[grepl("hsa",V(gr)$name)]=""
V(gr)$name[grepl("ENSG",V(gr)$name)]=""
plot.igraph(gr, layout=layout.auto,edge.color="grey80",vertex.color=V(gr)$color,vertex.label.cex=1,vertex.size=8,edge.width=1,vertex.label.color="black")
```


## no-MESO network

```{r network-gene-mirna-no-meso}
dd_reduce = merge(dd, dd_times, by="id") %>% filter( !grepl("MESO", contrast)) %>% dplyr::arrange(desc(times))
con = rbind( data.frame(start=dd_reduce$mirna, end=dd_reduce$gene),
             data.frame(start=dd_reduce$contrast, end=dd_reduce$mirna ))
con = con %>% distinct()
suppressMessages(library(igraph))
gr<-graph.data.frame(con, directed = F)
V(gr)$color<-"white"
V(gr)$color[grep("hsa-",V(gr)$name)]<-"orange"
V(gr)$color[grep("ENSG",V(gr)$name)]<-"grey80"
V(gr)$name[grepl("hsa",V(gr)$name)]=""
V(gr)$name[grepl("ENSG",V(gr)$name)]=""
plot.igraph(gr, layout=layout.auto,edge.color="grey80",vertex.color=V(gr)$color,vertex.label.cex=0.8,vertex.size=5,edge.width=2,vertex.label.color="black")
```

only taking interactions that appear  > 4 times

```{r network-gene-mirna-reduce}
dd_reduce = merge(dd, dd_times, by="id") %>% filter( times>4) %>% dplyr::arrange(desc(times))
con = rbind( data.frame(start=dd_reduce$mirna, end=dd_reduce$gene),
             data.frame(start=dd_reduce$contrast, end=dd_reduce$mirna ))
con = con %>% distinct()
suppressMessages(library(igraph))
gr<-graph.data.frame(con, directed = F)
V(gr)$color<-"white"
V(gr)$color[grep("hsa-",V(gr)$name)]<-"orange"
V(gr)$color[grep("ENSG",V(gr)$name)]<-"grey80"
V(gr)$name[grepl("hsa",V(gr)$name)]=""
V(gr)$name[grepl("ENSG",V(gr)$name)]=""
plot.igraph(gr, layout=layout.auto,edge.color="grey80",vertex.color=V(gr)$color,vertex.label.cex=0.8,vertex.size=5,edge.width=2,vertex.label.color="black")
```


## heatmap only with DE miRNA that target DE genes

```{r heatmap}
meta_sub = metadata[colnames(rlog_Mat),c("Diffname_short"),drop=F]
pheatmap(rlog_Mat[as.character(unique(dd$mirna)),], clustering_distance_rows = "correlation", clustering_distance_cols = "correlation", clustering_method = "ward", annotation = meta_sub, show_rownames = F,  show_colnames = F)

```

## Reducing interactions

### specific to state

interaction that appears < 5 but always is from different states to the same state

```{r summarize-unique}

single = dd_complete %>% filter(times<5 )

u_pairs = unique(as.character(single$id))

u_tab = lapply(u_pairs, function(p){
  unit = single %>% filter(id==p)
  states = as.vector(unlist(as.matrix(strsplit2(unit$contrast, split = "_"))[,c(3,5)]))
  if (nrow(unit) == 1){
    return(unit %>% mutate(direction=states[1]))
  }
  counts = table(gsub("15", "30", states))
  common = counts[counts==nrow(unit)]
  if (length(common) > 0){
    return(unit %>% mutate(direction=names(common)))
  }
})

u_tab = do.call(rbind, u_tab)
u_tab = u_tab[order(u_tab$direction),]
u_tab$id = factor(u_tab$id, levels = as.character(u_tab$id))

kable(as.data.frame(table(u_tab$direction)))

# ggplot(u_tab, aes(y=id, x=direction, fill=mrna_fc)) +
#  geom_tile()
```


### common to state

interactions that appears multiple times in many comparison. 

directions in the network means direction of the FC, and color, FC value. Example: Arrow from DE to ECTO with a blue color
mean down-regulated in ECTO.

```{r summarize-common}
ma_plot = dd_complete %>% filter(times > 4) %>% separate(contrast, c("type", "void", "g1", "vs", "g2"), sep = "_", remove=TRUE) %>%
  dplyr::select(id, mirna, gene, mirna_fc, mrna_fc, g1, g2)

suppressMessages(library(igraph))

.convert_to_gene <- function(m, to_name="external_gene_name"){
  require(biomaRt)
  ensembl = useMart('ensembl', dataset = "hsapiens_gene_ensembl")
  df = getBM(attributes=c("ensembl_gene_id", to_name), filters="ensembl_gene_id", values=as.character(m), mart=ensembl)
  return(df)
}
names = .convert_to_gene(unique(ma_plot$gene))

col_breaks = c(-10,-5, -1, -0.5, 0.5, 1, 5, 10)
col_col = rev(colorRampPalette(c("blue","grey80","orange"))(7))
par(mfrow=c(3,3))
for (u_id in unique(ma_plot$id)){
  con = ma_plot %>% filter(id == u_id)
  name_gene = names %>% filter(ensembl_gene_id==con$gene[1])
  # con[con$mrna_fc<0,c("g1","g2")] = con[con$mrna_fc<0,c("g2","g1")] 
  gr<-graph.data.frame(con[,c("g2","g1", "mrna_fc")], directed = T)
  E(gr)$color <- as.character(unlist(cut(con$mrna_fc, breaks = col_breaks, labels=col_col)))
  plot.igraph(gr, layout=layout.auto, vertex.color="white", edge.color=E(gr)$color, vertex.frame.color=NA, vertex.label.cex=0.7, vertex.size=35,edge.width=0.8,edge.arrow.size=0.2, vertex.label.color="black", main=paste(con$mirna[1], "->" ,name_gene[2]))
}
par(mfrow=c(1,1))
plot('1', type = 'n', axes = F, xlab="", ylab="")
legend("top", fill=col_col, legend = paste0(col_breaks[1:7], ", ",col_breaks[2:8]), box.lwd = 0, border = 0, horiz = T)
```

or another way to represent where these miRNAs-mRNA appears as a heatmap

```{r table-common-pairs}
ma_plot = dd_complete %>% filter(times>3) %>% separate(contrast, c("type", "void", "g1", "vs", "g2"), sep = "_", remove=TRUE) %>%
  dplyr::select(id, mirna, gene, mirna_fc, mrna_fc, g1, g2)
ma_plot_m = melt(ma_plot[,c("id", "mirna", "gene", "g1", "g2")], id.vars = c("id", "mirna", "gene"))
ma_plot_m = ma_plot_m[!duplicated(ma_plot_m[, c("id", "value")]),]

names = .convert_to_gene(unique(ma_plot$gene))
idx = match(ma_plot_m$gene, names$ensembl_gene_id)
ma_plot_m$gene_name = names[idx, "external_gene_name"]

ggplot(ma_plot_m, aes(x=value, y=paste0(mirna,">",gene_name), fill="seen")) +
  geom_tile() +
  scale_fill_manual(guide=FALSE,  values = "azure3") +
  xlab("") + ylab("")

write.table(names$external_gene_name, "../../data/network_heatmap_list.csv", quote=F, sep=",", row.names=F, col.names = F)
```



```{r network-common-pairs, eval=FALSE, echo=FALSE}
export = dd_complete[dd_complete$times>1,2:7]
export = dd_complete[!duplicated(dd_complete$id),2:7]
names = .convert_to_gene(export$gene)
idx = match(names$ensembl_gene_id, export$gene)
export[idx,"symbol"] = names[,"external_gene_name"]
write.table(export[export$times>1,], "../../data/network_example.csv", quote=F, sep=",", row.names=F)
write.table(export[export$times>2,"symbol"], "../../data/network_example_list.csv", quote=F, sep=",", row.names=F, col.names = F)


library(clusterProfiler)

.toname = function(x){
   require(org.Hs.eg.db)
    symbol = AnnotationDbi::select(org.Hs.eg.db, as.character(x), "ENTREZID", keytype="ENSEMBL")
    symbol = symbol %>% distinct(ENTREZID)
    symbol
}

select_prot = .toname(export$gene)
#ego <- groupGO(gene = select_prot$ENTREZID, 
               #organism = "human", ont = "BP", level=4)
               #pAdjustMethod = "BH",
               #pvalueCutoff = 0.01, qvalueCutoff = 0.05, readable = TRUE)

# head(summary(ego) %>% filter(Count>5) %>% arrange(desc(Count)), 20)


# barplot(ego, drop=T, showCategory=12)

# kk <- enrichKEGG(gene = select_prot$ENTREZID, organism = "human", pvalueCutoff = 0.05, readable = TRUE)
# head(summary(kk))

```

```{r nmf, eval=FALSE, echo=FALSE}
library(NMF)
sub_rlog = rlog_Mat[as.character(unique(dd$mirna)),]
res_nmf_4 = nmf(log2(sub_rlog^2+2), 4, nrun=20)
coefmap(res_nmf_4,annCol = meta_sub)
basismap(res_nmf_4, subsetRow=TRUE)
consensusmap(res_nmf_4, annCol = meta_sub)

# metagene
s = featureScore(res_nmf_4)
s = extractFeatures(res_nmf_4)
nmf_select = rownames(sub_rlog[unique(unlist(s)),])

sapply(s, function(x){
    rownames(sub_rlog)[x]
})

pheatmap(rlog_Mat[nmf_select,], clustering_distance_rows = "correlation", clustering_distance_cols = "correlation", clustering_method = "ward", annotation = meta_sub, show_rownames = F, show_colnames=F)
```

```{r store,eval=FALSE}
parentId = "syn4596210"
ActivityName = 'miRNA-mRNA network from mixedEffect DE'
library(rGithubClient)
# Github link
thisFileName = "miRNA_mRNA_network.Rmd"
thisRepo <- getRepo(repository = "lpantano/pcbc_c4_analysis", 
                    ref="branch", 
                    refName='master')

thisFile <- getPermlink(repository = thisRepo,
                        repositoryPath=paste0('code/Rmd/', thisFileName))

ALL_USED_IDs = c(mirna_rlog_obj$properties$id, metadata_obj@schema, mrna_logfc_obj@properties$id, mrna_pval_obj@properties$id, mirna_logfc_obj@properties$id, mirna_pval_obj@properties$id, meth_pval_id, meth_fc_id, meth_mirna_map_id)

CODE <- File(thisFileName,name = ActivityName,parentId = parentId)
CODE <- synStore(CODE, used = ALL_USED_IDs, activityName=ActivityName, executed=thisFile)

write.table(mrna_mirna_res, "../../data/miRNA-mRNA_mixedEffect_netowrk.tsv", quote=F, sep="\t", row.names=F)
res <- File('../../data/miRNA-mRNA_mixedEffect_netowrk.tsv',name = 'miRNA-mRNA network list',parentId = parentId)
res <- synStore(res, used = ALL_USED_IDs, activityName=ActivityName, executed=CODE)

write.table(meth_mirna_res, "../../data/miRNA-meth_mixedEffect_netowrk.tsv", quote=F, sep="\t", row.names=F)
res <- File('../../data/miRNA-meth_mixedEffect_netowrk.tsv',name = 'miRNA-meth network list',parentId = parentId)
res <- synStore(res, used = ALL_USED_IDs, activityName=ActivityName, executed=CODE)


devtools::source_gist("6117476")
knit2synapse("miRNA_mRNA_network.Rmd",
             owner=CODE@properties$id,
             overwrite=TRUE)
```

