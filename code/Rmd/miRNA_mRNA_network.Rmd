---
title: "miRNA-mRNA network analysis with mixed effect modilng"
author: "Lorena Pantano"
date: "`r date()`"
output: html_document
---

```{r knitr,eval=F,echo=F}
library(rmarkdown)
library(knitrBootstrap)
#render("~/repos/pcbc_c4_analysis/code/Rmd/miRNA_mRNA_network.Rmd", output_dir = "~/Dropbox/Public/hsph/pcbc")
```


Find miRNA-mRNA networks using limma:voom to detect DE features and miRBD v5 for miRNA-mRNA pairs.


```{r load}

library(tidyr)
library(dplyr)
library(knitr)
library(synapseClient)
library(limma)
library(reshape2)
library(gplots)
library(ggplot2)
library(RColorBrewer)
library(pheatmap)

options(bitmapType = 'cairo')

synapseLogin()

knitr::opts_chunk$set(tidy=TRUE, highlight=TRUE, dev="png", fig.width=9,fig.heigh=9,
               cache=FALSE, highlight=TRUE, autodep=TRUE, warning=FALSE, error=FALSE,
               message=FALSE, prompt=TRUE, comment='', fig.cap='', bootstrap.show.code=FALSE, echo=FALSE)

mirna_pval_obj =  synGet(id="syn4596141")
mirna_pval = read.table(mirna_pval_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")
mirna_logfc_obj =  synGet(id="syn4595547")
mirna_logfc = read.table(mirna_logfc_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")

mrna_logfc_obj =  synGet(id="syn4484226")
mrna_logfc = read.table(mrna_logfc_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")
mrna_pval_obj =  synGet(id="syn4484228")
mrna_pval = read.table(mrna_pval_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")


metadata_id = "syn3219876"
metadata_obj = synTableQuery(paste('SELECT * FROM',metadata_id,sep=' '))
metadata = metadata_obj@values %>% distinct(UID)
row.names(metadata) = metadata$UID
stages =  gsub("-", "", metadata$Diffname_short)
metadata$Diffname_short = as.character(stages)


mirna_rlog_obj =  synGet(id="syn4595556")
rlog_Mat = read.table(mirna_rlog_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")


mrna_metadata_id = "syn3156503"
mrna_metadata_obj = synTableQuery(paste('SELECT * FROM',mrna_metadata_id,sep=' '))
mrna_metadata = mrna_metadata_obj@values %>% distinct(UID)
row.names(mrna_metadata) = mrna_metadata$UID
stages =  gsub("-", "", mrna_metadata$Diffname_short)
mrna_metadata$Diffname_short = as.character(stages)


mrna_rlog_obj =  synGet(id="syn4483934")
rlog_mrna = read.table(mrna_rlog_obj@filePath, check.names = F, header=T, row.names=1, sep="\t")

meth_mirna_map_id = "syn4895962"
meth_mirna_map_obj = synGet(meth_mirna_map_id)
meth_mirna_map = read.table(meth_mirna_map_obj@filePath, header=F, sep="\t")
# meth_mirna_map = read.table("../../data/hm450_gene_annotations_mapped_mirna_tss.tsv", header=F, sep="\t")
names(meth_mirna_map) = c("meth", "mirna")

meth_pval_id = "syn4596513"
meth_pval_obj = synGet(meth_pval_id)
meth_pval = read.table(meth_pval_obj@filePath, header=TRUE, sep ="\t", row.names = 1)
#names(meth_pval) = gsub("vs", "_vs", names(meth_pval))

meth_fc_id = "syn4596511"
meth_fc_obj = synGet(meth_fc_id)
meth_fc = read.table(meth_fc_obj@filePath, header=TRUE, sep ="\t", row.names = 1)

.grep <- function(df, comp){
  idx = rowSums( sapply(paste0('_',comp,'_'), function(x)grepl(x, names(df))) ) > 0
  df[,idx]
}

.convert_to_ensembl <- function(m){
  require(biomaRt)
  ensembl = useMart('ensembl', dataset = "hsapiens_gene_ensembl")
  df = getBM(attributes=c("ensembl_gene_id", "external_gene_name"), filters="external_gene_name", values=as.character(rownames(m)), mart=ensembl)
  df = df %>% filter(ensembl_gene_id != "")
  new_m = m[as.character(df$external_gene_name),]
  row.names(new_m) = as.character(df$ensembl_gene_id)
  return(new_m)
}


format_table = function(m_logfc, m_pval, FC=2, PVAL=0.01, map=FALSE){
    if (map){
      m_logfc = .convert_to_ensembl(m_logfc)
      m_pval = .convert_to_ensembl(m_pval)
    }
    m_logfc = .grep(m_logfc, comp)
    m_pval = .grep(m_pval, comp)
    
    m_sig = lapply(names(m_pval), function(x){
      
      sig = m_pval[,x] < PVAL & abs(m_logfc[,x]) > FC
      sig[is.na(sig)] = FALSE
      if (sum(sig)>0){
        dt = data.frame(fc=m_logfc[sig, x],gene=rownames(m_logfc)[sig])
      
        dt$cont = x
        return(dt)
      }
    })
    do.call(rbind, m_sig)
}


comp = c("DE", "SC", "MESO5", "ECTO", "EB", "MESO15", "MESO30")

mirna_tab = format_table(mirna_logfc, mirna_pval, FC=2)
meth_tab = format_table(meth_fc, meth_pval, FC=0.2, PVAL=0.05)
mrna_tab = format_table(mrna_logfc, mrna_pval, FC=2, map=TRUE)

target_obj = synGet(id="syn3461627")
target = read.table(target_obj@filePath, check.names = F, header=F, sep="\t")
names(target) = c("mirna","gene")
target = target[!duplicated(target),]
```

# Detect networks

For mRNA and miRNA using adjusted pval < 0.01 and abs(logFC) > 2 and for methylation, abs(logFC) > 0.2 and FDR < 0.05 to get more interactions.

```{r create-network}
network_list = list()
for (contrast in intersect(unique(mrna_tab$cont), unique(mirna_tab$cont)) ){
    genes_de = mrna_tab %>% filter(cont == contrast )
    mirna_de = mirna_tab %>% filter(cont == contrast)
    target_de = target %>% filter(gene %in% genes_de$gene)  %>% filter(mirna %in% mirna_de$gene)
    idx_mirna = match(target_de$mirna, mirna_de$gene)
    idx_mrna = match(target_de$gene, genes_de$gene)
    target_de[!is.na(idx_mirna),"mirna_fc"] = mirna_de$fc[idx_mirna[!is.na(idx_mirna)]]
    target_de[!is.na(idx_mrna),"mrna_fc"] = genes_de$fc[idx_mrna[!is.na(idx_mrna)]]
    network = target_de %>% filter(!is.na(mirna_fc) & !is.na(mrna_fc) & mirna_fc * mrna_fc < 0)
    if (dim(network)[1]>0){
      network_list[[contrast]] = network %>% mutate(contrast = contrast)
    }
}

network_meth_list = list()
for (contrast in intersect(unique(meth_tab$cont), unique(mirna_tab$cont)) ){
    genes_de = meth_tab %>% filter(cont == contrast )
    mirna_de = mirna_tab %>% filter(cont == contrast)
    target_de = meth_mirna_map %>% filter(meth %in% genes_de$gene & mirna %in% mirna_de$gene)
    idx_mirna = match(target_de$mirna, mirna_de$gene)
    idx_mrna = match(target_de$meth, genes_de$gene)
    target_de[!is.na(idx_mirna),"mirna_fc"] = mirna_de$fc[idx_mirna[!is.na(idx_mirna)]]
    target_de[!is.na(idx_mrna),"meth_fc"] = genes_de$fc[idx_mrna[!is.na(idx_mrna)]]
    network = target_de %>% filter(!is.na(mirna_fc) & !is.na(meth_fc) & mirna_fc * meth_fc < 0)
    if (dim(network)[1]>0){
      network_meth_list[[contrast]] = network %>% mutate(contrast = contrast)
    }
}

```

# Numbers of interaction in all comparisons

## For mRNA-miRNA

```{r summary, results='asis'}
kable(as.data.frame(sapply(network_list, nrow)))
```

## For methylation-miRNA

```{r summary-meth, results='asis'}
kable(as.data.frame(sapply(network_meth_list, nrow)))
```

## Common interactions for mRNA-miRNA

```{r summary-unique, results='asis'}
dd = do.call(rbind, network_list) 
dd$id = paste0(dd$mirna,"->",dd$gene, "@", dd$contrast)
dd$interaction = paste0(dd$mirna,"->",dd$gene)
dd = dd %>% filter(!duplicated(c(id)))
dd_times = dd %>% group_by(interaction) %>% dplyr::summarise(times = n()) %>% dplyr::arrange(desc(times))
dd_complete = merge(dd, dd_times, by="interaction") %>% dplyr::arrange(desc(times))

kable(head(merge(dd, dd_times, by="interaction") %>% filter(times>1) %>% dplyr::arrange(desc(times))))

```

## methylation - miRNA - mRNA interaction

Number of genes with methylation-miRNA-mRNA interactions

```{r c3-network}
meth_mirna_res = do.call(rbind,network_meth_list) %>% mutate(id=paste0(mirna,"@", contrast))
mrna_mirna_res = do.call(rbind,network_list) %>% mutate(id=paste0(mirna, "@",contrast))

c3_res = merge(mrna_mirna_res, meth_mirna_res, by ='id')

kable(as.data.frame(table(c3_res$contrast.x)))

```

# Importants miRNAs for each state

The idea is to take the most important miRNAs that repressed a set of genes in each state
that we assume are the ones controling tahta the state remains like it is.

So we are lookgin really at UP miRNAs that control the down-regulated genes that
are unique to this state. So, we asume that changes in these genes would start
a differentiation to other state. As a note, downregulated doesn't mean low expressed,
some of them are low expressed, others are lower than other state.

Steps for each state:

* take only unique downregulated genes for this state. That means that those
genes are differentially down-regulated from any other state to this one
* counts the miRNAs that interact those genes and the ones that are UP are
the candidates that control those genes that are down. 
* take the miRNAs that target more genes (top 10, but we can add some stats here to chose better)
* group these miRNAs if they have many common targets (set to > 50% in common)
* remove miRNAs that targets < 10% of all the genes and are not group to any other miRNA
* remove genes that after the 2 previous step have no miRNAs targeting them
* plot mRNA expression (scale by row) in all states and annotate at the left 
which miRNAs are regulating them (black:yes, white:no)

```{r co-profile}

states = c("DE", "SC", "EB", "ECTO", "MESO5", "MESO15", "MESO30")

.name2entrez = function(x, out="list"){
    require(org.Hs.eg.db)
    symbol = AnnotationDbi::select(org.Hs.eg.db, as.character(x), "ENTREZID", keytype="ENSEMBL")
    symbol = symbol %>% distinct(ENTREZID)
    if (out=="table")
        return(symbol)
    symbol$ENTREZID[!is.na(symbol$ENTREZID)]
}

.list = lapply(states, function(state){
  
  idx = grepl(state, unique(mrna_mirna_res$contrast))
  .genes=lapply(unique(mrna_mirna_res$contrast)[idx], function(comp){
    .split = unlist(strsplit2(comp,"_"))
    .side = which(.split==state)
    if (.side==3){
      .res = mrna_mirna_res %>% filter(contrast==comp & mrna_fc < 0)
    }else{
      .res = mrna_mirna_res %>% filter(contrast==comp & mrna_fc > 0)
    }
    return(.res$gene)
  })
  
  
  .genes = unique(unlist(.genes))
  .mirna = mrna_mirna_res %>% filter(grepl(state,contrast) & gene %in% .genes) %>% 
    distinct(gene,mirna) %>% group_by(mirna) %>% summarise(times=n()) %>% arrange(desc(times))
  .entrez = .name2entrez(.genes)
  return(list(entrez=.entrez, ensembl=.genes, mirna=.mirna))  

})

names(.list) = states


.name2symbol = function(x, out="list"){
    require(org.Hs.eg.db)
    symbol = AnnotationDbi::select(org.Hs.eg.db, as.character(x), "SYMBOL", keytype="ENSEMBL")
    symbol = symbol %>% distinct(SYMBOL)
    if (out=="table"){
        idx = match(as.character(x), symbol$ENSEMBL)
        symbol = symbol[idx,]
        symbol$SYMBOL[is.na(symbol$ENSEMBL)] = symbol$ENSEMBL[is.na(symbol$ENSEMBL)]
        return(symbol$SYMBOL)
      }
    symbol$SYMBOL[!is.na(symbol$SYMBOL)]
}

mrna_mirna_res$symbol = .name2symbol(mrna_mirna_res$gene, out='table')

# .up_genes = as.character(unlist(unique(lapply(.list, function(x){x$ensembl}))))
```

```{r reduce}
# this_state = 'MESO15'
.top_mirna = unique(as.character(unlist(lapply(states, function(state){
    unlist(.list[[state]]$mirna[1:5,"mirna"])
  }))))


.get_mirna_mrna_ma = function(.toy, min_total=0.1){
  .seen = vector()
  .sort_mirna = sort(colSums(.toy=="Target"), decreasing = T)
  .pairs = vector("list", length=length(.sort_mirna))
  for (nc1 in 1:length(.sort_mirna)){
    for (nc2 in 1:length(.sort_mirna)){
      if (nc1 != nc2 & sum(.seen==nc2)==0){
        .name1 = names(.sort_mirna)[nc1]
        .name2 = names(.sort_mirna)[nc2]
        .these1 = rownames(.toy)[.toy[,.name1]=="Target"]
        .these2 = rownames(.toy)[.toy[,.name2]=="Target"]
        .min = min(length(.these1), length(.these2))
        .common = length(intersect(.these1, .these2))
        if ( (.common / .min) > 0.50 ){
          .seen = unique(c(.seen , nc2, nc1))
          .pairs[[nc1]] = c(.pairs[[nc1]], nc2)
        }
      }
    }
  }
  
  .others = c()
  for (nc1 in 1:length(.sort_mirna)){
    if (sum(.seen==nc1)==0 ){
      .these1 = rownames(.toy)[.toy[,nc1]=="Target"]
      if ( length(.these1) / nrow(.toy) >= min_total ){
        .pairs[[nc1]] = c(.pairs[[nc1]], nc1)
      }#else{
      #.others = c(.others, nc1)
      #}
      .seen = c(.seen , nc1)
    }
  }
  
  .toyb <- matrix(ncol=ncol(.toy), nrow=nrow(.toy))
  rownames(.toyb)= rownames(.toy)
  colnames(.toyb)= colnames(.toy)
  .toyb[.toy=="None"] = 0
  .toyb[.toy!="None"] = 1
  .toyb_red = lapply(1:length(.sort_mirna), function(x){
    if ( ! is.null(.pairs[[x]]) ){
      .join = unique(c(names(.sort_mirna)[x],names(.sort_mirna)[.pairs[[x]]]))
      .name = gsub("hsa-miR-", "", paste0(.join, collapse = ","))
      .news = rowSums(.toyb[,.join, drop=F])
      .news[.news>0] = 1
      if ( sum(.news) >= nrow(.toyb) * min_total)
        return(list(v=.news, n=.name, real=.join))
    }
  })
  
  .used = unique(unlist(lapply(.toyb_red, function(x){
    x$real
  })))
  .names = unlist(lapply(.toyb_red, function(x){
    x$n
  }))
  .toyb_red = do.call(cbind, lapply(.toyb_red, function(x){
    x$v
  }))
  colnames(.toyb_red) = .names
  print(.names)
  .toyb_red = as.data.frame(.toyb_red)
  #.join = c(names(.sort_mirna)[.others])
  #.toyb_red$others = rowSums(.toyb[,.join])
  .toy_hc = hclust(dist(t(.toyb_red), method='binary'))
  
  .toy_red = .toyb_red
  .toy_red[.toyb_red==0] = "None"
  .toy_red[.toyb_red!=0] = "Target"
  .ann_colors = lapply(colnames(.toy_red), function(x) {c(None="white", Target="black")})
  names(.ann_colors) = colnames(.toy_red)
  return(list(bin=.toyb_red, cat=.toy_red, cols=.ann_colors, hc=.toy_hc, used =.used))
}

all_tab_mrna = data.frame()
all_tab_ann = data.frame()
.states_lvs = factor(states, levels = c("SC", "DE", "MESO5",  "ECTO", "EB","MESO15", "MESO30"))

all_info = lapply(as.character(levels(.states_lvs)), function(this_state){
  print(this_state)
  .top_mirna = as.character(unique(unlist(.list[[this_state]]$mirna[1:10,"mirna"])))
  .down_genes = as.character(unique(unlist(.list[[this_state]]$ensembl)))
  .all_genes = (mrna_mirna_res %>% filter(!grepl(this_state, contrast)))[,"gene"]
  .down_uni = setdiff(.down_genes, .all_genes)
  
  .filtered = mrna_mirna_res %>% filter(mirna %in% .top_mirna & gene %in% .down_uni) %>% filter(!is.na(symbol))
  .mrna_exp = rlog_mrna[as.character(unique(.filtered$symbol)),]
  .mirna_exp = rlog_Mat[as.character(unique(.filtered$mirna)),]
  
  
  .median_by_group = function(mat, meta){
    meta = meta[colnames(mat),]
    .merge = do.call(cbind, lapply(states, function(state){
      .these = as.character((meta  %>% filter(Diffname_short == state))[,"UID"])
      
      .summarize = apply(mat[,.these],1,median)
    }))
    colnames(.merge) = states
    .merge[!is.na(rowSums(.merge)),]
    
  }
  
  
  mirna_keep = .median_by_group(.mirna_exp, metadata)
  mrna_keep = .median_by_group(.mrna_exp, mrna_metadata)
  
  
  .hc = function(mat){
    hclust(as.dist(1-cor(t(mat))), method="ward.D2")
  }
  
  
  .plot_heatmap = function(mat, lvls){
    ._plot = melt(as.data.frame(mat) %>%  mutate(feature=rownames(mat)))
    ._plot$mirna = factor(._plot$feature, levels=levels(lvls))
    ._plot$variable = factor(._plot$variable, levels=levels(.states_lvs))
    
    p = ggplot(._plot, aes(x=variable, y=feature, fill=value)) +
      geom_tile() +
      scale_fill_gradient2(low="blue", mid = "white", high = "orange", midpoint = 3)
    print(p)
  }
  
  
  .mirna_hc = .hc(mirna_keep)
  .mirna_levels = .mirna_hc$labels[.mirna_hc$order]
  # .plot_heatmap(mirna_keep, .mirna_levels)
  
  # .mrna_hc = .hc(mrna_keep)
  # .mrna_levels = .mrna_hc$labels[.mrna_hc$order]
  # .plot_heatmap(mrna_keep, .mrna_levels)
  .toy = matrix(ncol=nrow(.mirna_exp), nrow=nrow(.mrna_exp))
  rownames(.toy)= rownames(.mrna_exp)
  colnames(.toy)= rownames(.mirna_exp)
  .toy[is.na(.toy)] = "None"
  .void = apply(.filtered, 1, function(x){
    x = as.character(x)
    if ( sum(x[7]==rownames(.toy))>0 & sum(x[1]==colnames(.toy))>0 )
      .toy[x[7], x[1]] <<- "Target"
  })
  

  .mirna_mrna_ma = .get_mirna_mrna_ma(.toy)  
  .toyb_red = .mirna_mrna_ma$bin
  .toy_red = .mirna_mrna_ma$cat
  .ann_colors = .mirna_mrna_ma$cols
  .toy_hc = .mirna_mrna_ma$hc
  # pheatmap(mrna_keep[.mrna_levels,.states_lvs], show_rownames = FALSE, cluster_cols = FALSE, clustering_method = "ward")
  # pheatmap(mrna_keep[.mrna_levels,.states_lvs], show_rownames = FALSE, cluster_cols = FALSE, clustering_method = "ward", scale='row')
  .regulated = rownames(.toyb_red)[rowSums(.toyb_red)>0]
  .ma = mrna_keep[.regulated, ]
  .ma_hc = hclust(as.dist(1-cor(t(.ma))^2))
  # .ma_hc = hclust(dist(mrna_keep[.regulated,], method = 'manhattan'))
  print(pheatmap(.ma[.ma_hc$order ,.states_lvs], show_rownames = FALSE, cluster_cols = FALSE, cluster_rows = FALSE,annotation_row = as.data.frame(.toy_red[,.toy_hc$order]), annotation_colors = .ann_colors, scale = 'row', annotation_legend = FALSE))
  # pheatmap(mirna_keep[.mirna_levels,.states_lvs], show_rownames = FALSE, cluster_cols = FALSE, clustering_method = "ward")
  list(ma = .ma[.ma_hc$order ,.states_lvs], ann=as.data.frame(.toy_red[,.toy_hc$order]), col=.ann_colors, 
       used=.mirna_mrna_ma$used)
})
```

## All together

basically took all previous heatmaps and paste one after another. 
the miRNA annotation is redone here. Just take all miRNAs in the previous heatmaps
and group again together according to targets, but without removing anyone. Here I just added
some miRNA-gene annotation at the left since we have more genes here.

```{r plot}
pheatmap(all_info[[1]]$ma, show_rownames = FALSE, cluster_cols = FALSE, cluster_rows = FALSE,annotation_row = all_info[[1]]$ann, annotation_colors = all_info[[1]]$col , scale = 'row')

all_ma = do.call(rbind, lapply(all_info, function(x){x$ma}))
all_used = unique(unlist(lapply(all_info, function(x){x$used})))
.filtered = mrna_mirna_res %>% filter(mirna %in% all_used & symbol %in% as.character(rownames(all_ma))) %>% filter(!is.na(symbol))

.toy = matrix(ncol=length(all_used), nrow=nrow(all_ma))
rownames(.toy)= rownames(all_ma)
colnames(.toy)= all_used
.toy[is.na(.toy)] = "None"
.void = apply(.filtered, 1, function(x){
  x = as.character(x)
  if ( sum(x[7]==rownames(.toy))>0 & sum(x[1]==colnames(.toy))>0 )
    .toy[x[7], x[1]] <<- "Target"
})


.mirna_mrna_ma = .get_mirna_mrna_ma(.toy, min_total = 0)  
.toyb_red = .mirna_mrna_ma$bin
.toy_red = .mirna_mrna_ma$cat
.ann_colors = .mirna_mrna_ma$cols
.toy_hc = .mirna_mrna_ma$hc

pheatmap(all_ma, show_rownames = FALSE, cluster_cols = FALSE, cluster_rows = FALSE, scale='row', annotation_legend = FALSE,
         annotation_row = as.data.frame(.toy_red[,.toy_hc$order]), annotation_colors = .ann_colors)

```


```{r enrichemnt-mirna-mrnai, eval=FALSE}
# Enrichment analysis for each state

library(clusterProfiler)

tab = lapply(states, function(state){
  kk <- enrichKEGG(gene = .list[[state]]$entrez, organism = "human", pvalueCutoff = 0.05, readable = TRUE)
  as.data.frame(summary(kk)[1:6]) %>% mutate(state=state)
})

tab = do.call(rbind,tab)
tab = merge(tab, tab %>% group_by(Description) %>% summarise(times=n()), by="Description")

ggplot(tab %>% filter(times<3), aes(x=state, y=Description, fill=-log10(p.adjust))) +
  geom_tile()

# barplot(kk,showCategory=12)
# cnetplot(kk, categorySize="geneNum")

# library("pathview")
# hsa04550 <- pathview(gene.data = .list[['SC']]$entrez, xml.file = "hsa04550.xml", pathway.id = "hsa04550",species = "hsa")


# mirnatab = do.call(rbind, lapply(states, function(state){ 
#  .list[[state]]$mirna[1:10,] %>% mutate(state=state) }))
#mirnatab$state = factor(mirnatab$state, levels=c("SC","DE","MESO5","ECTO","EB"))
#ggplot(mirnatab , aes(x=state, y=mirna, fill=times)) +
#  geom_tile()

```

```{r pheatmap, eval=FALSE, echo=FALSE}
tt = apply(dd_complete, 1, function(x){
  comp = unlist(strsplit(x[6],split = "_"))
  #g1 = c(x[1], x[5], comp[3])
  #g2 = c(x[1], -1 * as.numeric(x[5]), comp[5])
  return(  data.frame(pair=c(x[1], x[1]), fc=c(x[5], -1 * as.numeric(x[5])), comp=c(comp[3], comp[5])  ))
})

tt = do.call(rbind,tt)

tt$fc = as.numeric(as.character(tt$fc))

tt_m = reshape(as.data.frame(tt), direction = 'wide', idvar='pair', timevar = "comp")
tt_m[is.na(tt_m)] = 0
pheatmap(tt_m, show_rownames = FALSE)
```

```{r network-gene-mirna-meso-early, fig.width=11, fig.height=11, eval=FALSE, echo=FALSE}
dd_reduce = merge(dd, dd_times, by="id")  %>% filter(grepl("MESO5", contrast) & !grepl("MESO15", contrast)) %>% dplyr::arrange(desc(times)) %>% mutate(contrast=gsub("MESO30", "", contrast))
con = rbind( data.frame(start=dd_reduce$mirna, end=dd_reduce$gene),
             data.frame(start=dd_reduce$contrast, end=dd_reduce$mirna ))
con = con %>% distinct()
suppressMessages(library(igraph))
gr<-graph.data.frame(con, directed = F)
V(gr)$color<-"white"
V(gr)$color[grep("hsa-",V(gr)$name)]<-"orange"
V(gr)$color[grep("ENSG",V(gr)$name)]<-"black"
V(gr)$name[grepl("hsa",V(gr)$name)]=""
V(gr)$name[grepl("ENSG",V(gr)$name)]=""
plot.igraph(gr, layout=layout.auto,edge.color="grey80",vertex.color=V(gr)$color,vertex.label.cex=1,vertex.size=8,edge.width=1,vertex.label.color="black")
```

```{r network-gene-mirna-no-meso, eval=FALSE}
dd_reduce = merge(dd, dd_times, by="id") %>% filter( !grepl("MESO", contrast)) %>% dplyr::arrange(desc(times))
con = rbind( data.frame(start=dd_reduce$mirna, end=dd_reduce$gene),
             data.frame(start=dd_reduce$contrast, end=dd_reduce$mirna ))
con = con %>% distinct()
suppressMessages(library(igraph))
gr<-graph.data.frame(con, directed = F)
V(gr)$color<-"white"
V(gr)$color[grep("hsa-",V(gr)$name)]<-"orange"
V(gr)$color[grep("ENSG",V(gr)$name)]<-"grey80"
V(gr)$name[grepl("hsa",V(gr)$name)]=""
V(gr)$name[grepl("ENSG",V(gr)$name)]=""
plot.igraph(gr, layout=layout.auto,edge.color="grey80",vertex.color=V(gr)$color,vertex.label.cex=0.8,vertex.size=5,edge.width=2,vertex.label.color="black")
```

```{r network-gene-mirna-reduce, eval=FALSE}
dd_reduce = merge(dd, dd_times, by="id") %>% filter( times>4) %>% dplyr::arrange(desc(times))
con = rbind( data.frame(start=dd_reduce$mirna, end=dd_reduce$gene),
             data.frame(start=dd_reduce$contrast, end=dd_reduce$mirna ))
con = con %>% distinct()
suppressMessages(library(igraph))
gr<-graph.data.frame(con, directed = F)
V(gr)$color<-"white"
V(gr)$color[grep("hsa-",V(gr)$name)]<-"orange"
V(gr)$color[grep("ENSG",V(gr)$name)]<-"grey80"
V(gr)$name[grepl("hsa",V(gr)$name)]=""
V(gr)$name[grepl("ENSG",V(gr)$name)]=""
plot.igraph(gr, layout=layout.auto,edge.color="grey80",vertex.color=V(gr)$color,vertex.label.cex=0.8,vertex.size=5,edge.width=2,vertex.label.color="black")
```


## heatmap only with DE miRNA that target DE genes

```{r heatmap}
meta_sub = metadata[colnames(rlog_Mat),c("Diffname_short"),drop=F]
pheatmap(rlog_Mat[as.character(unique(dd$mirna)),], clustering_distance_rows = "correlation", clustering_distance_cols = "correlation", clustering_method = "ward", annotation = meta_sub, show_rownames = F,  show_colnames = F)

```

```{r summarize-unique, eval=FALSE}

single = dd_complete %>% filter(times<5 )

u_pairs = unique(as.character(single$id))

u_tab = lapply(u_pairs, function(p){
  unit = single %>% filter(id==p)
  states = as.vector(unlist(as.matrix(strsplit2(unit$contrast, split = "_"))[,c(3,5)]))
  if (nrow(unit) == 1){
    return(unit %>% mutate(direction=states[1]))
  }
  counts = table(gsub("15", "30", states))
  common = counts[counts==nrow(unit)]
  if (length(common) > 0){
    return(unit %>% mutate(direction=names(common)))
  }
})

u_tab = do.call(rbind, u_tab)
u_tab = u_tab[order(u_tab$direction),]
u_tab$id = factor(u_tab$id, levels = as.character(u_tab$id))

kable(as.data.frame(table(u_tab$direction)))

# ggplot(u_tab, aes(y=id, x=direction, fill=mrna_fc)) +
#  geom_tile()
```

```{r summarize-common, eval=FALSE}
ma_plot = dd_complete %>% filter(times > 4) %>% separate(contrast, c("type", "void", "g1", "vs", "g2"), sep = "_", remove=TRUE) %>%
  dplyr::select(id, mirna, gene, mirna_fc, mrna_fc, g1, g2)

suppressMessages(library(igraph))

.convert_to_gene <- function(m, to_name="external_gene_name"){
  require(biomaRt)
  ensembl = useMart('ensembl', dataset = "hsapiens_gene_ensembl")
  df = getBM(attributes=c("ensembl_gene_id", to_name), filters="ensembl_gene_id", values=as.character(m), mart=ensembl)
  return(df)
}
names = .convert_to_gene(unique(ma_plot$gene))

col_breaks = c(-10,-5, -1, -0.5, 0.5, 1, 5, 10)
col_col = rev(colorRampPalette(c("blue","grey80","orange"))(7))
par(mfrow=c(3,3))
for (u_id in unique(ma_plot$id)){
  con = ma_plot %>% filter(id == u_id)
  name_gene = names %>% filter(ensembl_gene_id==con$gene[1])
  # con[con$mrna_fc<0,c("g1","g2")] = con[con$mrna_fc<0,c("g2","g1")] 
  gr<-graph.data.frame(con[,c("g2","g1", "mrna_fc")], directed = T)
  E(gr)$color <- as.character(unlist(cut(con$mrna_fc, breaks = col_breaks, labels=col_col)))
  plot.igraph(gr, layout=layout.auto, vertex.color="white", edge.color=E(gr)$color, vertex.frame.color=NA, vertex.label.cex=0.7, vertex.size=35,edge.width=0.8,edge.arrow.size=0.2, vertex.label.color="black", main=paste(con$mirna[1], "->" ,name_gene[2]))
}
par(mfrow=c(1,1))
plot('1', type = 'n', axes = F, xlab="", ylab="")
legend("top", fill=col_col, legend = paste0(col_breaks[1:7], ", ",col_breaks[2:8]), box.lwd = 0, border = 0, horiz = T)
```

```{r table-common-pairs, eval=FALSE}
ma_plot = dd_complete %>% filter(times>3) %>% separate(contrast, c("type", "void", "g1", "vs", "g2"), sep = "_", remove=TRUE) %>%
  dplyr::select(id, mirna, gene, mirna_fc, mrna_fc, g1, g2)
ma_plot_m = melt(ma_plot[,c("id", "mirna", "gene", "g1", "g2")], id.vars = c("id", "mirna", "gene"))
ma_plot_m = ma_plot_m[!duplicated(ma_plot_m[, c("id", "value")]),]

names = .convert_to_gene(unique(ma_plot$gene))
idx = match(ma_plot_m$gene, names$ensembl_gene_id)
ma_plot_m$gene_name = names[idx, "external_gene_name"]

ggplot(ma_plot_m, aes(x=value, y=paste0(mirna,">",gene_name), fill="seen")) +
  geom_tile() +
  scale_fill_manual(guide=FALSE,  values = "azure3") +
  xlab("") + ylab("")

write.table(names$external_gene_name, "../../data/network_heatmap_list.csv", quote=F, sep=",", row.names=F, col.names = F)
```

```{r network-common-pairs, eval=FALSE, echo=FALSE}
export = dd_complete[dd_complete$times>1,2:7]
export = dd_complete[!duplicated(dd_complete$id),2:7]
names = .convert_to_gene(export$gene)
idx = match(names$ensembl_gene_id, export$gene)
export[idx,"symbol"] = names[,"external_gene_name"]
write.table(export[export$times>1,], "../../data/network_example.csv", quote=F, sep=",", row.names=F)
write.table(export[export$times>2,"symbol"], "../../data/network_example_list.csv", quote=F, sep=",", row.names=F, col.names = F)


library(clusterProfiler)

.toname = function(x){
   require(org.Hs.eg.db)
    symbol = AnnotationDbi::select(org.Hs.eg.db, as.character(x), "ENTREZID", keytype="ENSEMBL")
    symbol = symbol %>% distinct(ENTREZID)
    symbol
}

select_prot = .toname(export$gene)
#ego <- groupGO(gene = select_prot$ENTREZID, 
               #organism = "human", ont = "BP", level=4)
               #pAdjustMethod = "BH",
               #pvalueCutoff = 0.01, qvalueCutoff = 0.05, readable = TRUE)

# head(summary(ego) %>% filter(Count>5) %>% arrange(desc(Count)), 20)


# barplot(ego, drop=T, showCategory=12)

# kk <- enrichKEGG(gene = select_prot$ENTREZID, organism = "human", pvalueCutoff = 0.05, readable = TRUE)
# head(summary(kk))

```

```{r nmf, eval=FALSE, echo=FALSE}
library(NMF)
sub_rlog = rlog_Mat[as.character(unique(dd$mirna)),]
res_nmf_4 = nmf(log2(sub_rlog^2+2), 4, nrun=20)
coefmap(res_nmf_4,annCol = meta_sub)
basismap(res_nmf_4, subsetRow=TRUE)
consensusmap(res_nmf_4, annCol = meta_sub)

# metagene
s = featureScore(res_nmf_4)
s = extractFeatures(res_nmf_4)
nmf_select = rownames(sub_rlog[unique(unlist(s)),])

sapply(s, function(x){
    rownames(sub_rlog)[x]
})

pheatmap(rlog_Mat[nmf_select,], clustering_distance_rows = "correlation", clustering_distance_cols = "correlation", clustering_method = "ward", annotation = meta_sub, show_rownames = F, show_colnames=F)
```

```{r store, eval=FALSE}
parentId = "syn4596210"
ActivityName = 'miRNA-mRNA network from mixedEffect DE'
library(rGithubClient)
# Github link
thisFileName = "miRNA_mRNA_network.Rmd"
thisRepo <- getRepo(repository = "lpantano/pcbc_c4_analysis", 
                    ref="branch", 
                    refName='master')

thisFile <- getPermlink(repository = thisRepo,
                        repositoryPath=paste0('code/Rmd/', thisFileName))

ALL_USED_IDs = c(mirna_rlog_obj$properties$id, metadata_obj@schema, mrna_logfc_obj@properties$id, mrna_pval_obj@properties$id, mirna_logfc_obj@properties$id, mirna_pval_obj@properties$id, meth_pval_id, meth_fc_id, meth_mirna_map_id, mrna_rlog_obj@properties$id)

CODE <- File(thisFileName,name = ActivityName,parentId = parentId)
CODE <- synStore(CODE, used = ALL_USED_IDs, activityName=ActivityName, executed=thisFile)

write.table(mrna_mirna_res, "../../data/miRNA-mRNA_mixedEffect_netowrk.tsv", quote=F, sep="\t", row.names=F)
res <- File('../../data/miRNA-mRNA_mixedEffect_netowrk.tsv',name = 'miRNA-mRNA network list',parentId = parentId)
res <- synStore(res, used = ALL_USED_IDs, activityName=ActivityName, executed=CODE)

write.table(meth_mirna_res, "../../data/miRNA-meth_mixedEffect_netowrk.tsv", quote=F, sep="\t", row.names=F)
res <- File('../../data/miRNA-meth_mixedEffect_netowrk.tsv',name = 'miRNA-meth network list',parentId = parentId)
res <- synStore(res, used = ALL_USED_IDs, activityName=ActivityName, executed=CODE)


devtools::source_gist("6117476")
knit2synapse("miRNA_mRNA_network.Rmd",
             owner=CODE@properties$id,
             overwrite=TRUE)
```

